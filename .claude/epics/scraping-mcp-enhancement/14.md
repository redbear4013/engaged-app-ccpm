---
name: Database Schema & Supabase Setup
status: open
created: 2025-10-01T01:34:04Z
updated: 2025-10-01T01:34:04Z
github: https://github.com/redbear4013/engaged-app-ccpm/issues/14
depends_on: []
parallel: true
conflicts_with: []
---

# Task: Database Schema & Supabase Setup

## Description

**Extend existing Supabase schema** with new tables required for the enhanced scraping system. The base schema (events, event_sources, scrape_jobs) already exists from the event-calendar-app epic. This task adds event_revisions for change tracking, scraping_runs for metrics, scraping_logs for debugging, and circuit_breaker_state for resilience. Update RLS policies and add performance indexes for new query patterns.

## Acceptance Criteria

- [ ] **Existing tables verified**: `events`, `event_sources`, `scrape_jobs` tables confirmed functional
- [ ] `event_revisions` table created for temporal tracking of event changes (NEW)
- [ ] `scraping_runs` table created for execution metadata per source (NEW - replaces/extends scrape_jobs)
- [ ] `scraping_logs` table created for detailed operation logs (NEW)
- [ ] `circuit_breaker_state` table created for fault tolerance state (NEW)
- [ ] Row-level security (RLS) policies updated for new tables
- [ ] Indexes created for new query patterns (revision lookups, run metrics, log searches)
- [ ] Foreign key relationships properly defined for new tables
- [ ] Migration scripts are idempotent and versioned
- [ ] Sample data seeded for development/testing of new tables

## Technical Details

- **Implementation approach**:
  - **Audit existing schema**: Review `supabase/migrations/20250101000001_initial_schema.sql` for current structure
  - Create new migration: `supabase/migrations/[timestamp]_scraping_enhancements.sql`
  - Implement temporal tracking in `event_revisions` with `changed_at`, `field_name`, `old_value`, `new_value`
  - Circuit breaker state uses dedicated columns (not JSONB) for queryability: `state`, `failure_count`, `open_until`
  - Logs use JSONB `metadata` field for flexible structured data
  - RLS policies: Service role bypasses, admin role read access, public no access
  - **Migration strategy**: Add-only (no ALTER on existing tables to avoid breaking changes)

- **Key considerations**:
  - `scraping_runs` extends/replaces `scrape_jobs` with richer metrics (engine used, field coverage %, duration_ms)
  - Revisions table enables point-in-time queries for event history and change notifications
  - Indexes on frequently queried fields: `scraping_runs(source_id, started_at)`, `scraping_logs(run_id, level)`
  - Circuit breaker state: Unique constraint on `source_id`, updated in-place (not temporal)
  - Consider TimescaleDB extension for `scraping_logs` if volume >1M rows/month
  - Supabase Realtime subscriptions for dashboard (already enabled)

- **Code locations/files affected**:
  - `supabase/migrations/20250101000001_initial_schema.sql` (REVIEW ONLY - existing)
  - `supabase/migrations/[NEW]_scraping_enhancements.sql` (NEW)
  - `supabase/migrations/[NEW]_scraping_indexes.sql` (NEW)
  - `supabase/migrations/[NEW]_scraping_rls_policies.sql` (NEW)
  - `supabase/seed.sql` (extend with sample scraping data)
  - `src/lib/supabase/schema.ts` (regenerate TypeScript types)

## Dependencies

- [x] **Existing**: Supabase project already configured (event-calendar-app Task #2)
- [x] **Existing**: Base schema tables (events, event_sources, scrape_jobs, profiles, etc.)
- [ ] Supabase CLI installed for running new migrations
- [ ] Database connection credentials verified in `.env.local`
- [ ] TypeScript type generation configured (may already exist)

## Effort Estimate

- Size: S (reduced from M since base schema exists)
- Hours: 4-6 (reduced from 8-10)
- Parallel: true

## Definition of Done

- [ ] All migration scripts executed successfully
- [ ] Database schema matches design specification
- [ ] RLS policies tested with different auth contexts
- [ ] Indexes verified to improve query performance (EXPLAIN ANALYZE)
- [ ] TypeScript types auto-generated from schema
- [ ] Sample data inserted and queries validated
- [ ] Migration rollback tested
- [ ] Schema documented in README or docs/database.md
- [ ] Code reviewed and approved
- [ ] Deployed to staging environment
