---
name: Testing & Quality Assurance
status: backlog
created: 2025-10-01T01:34:04Z
updated: 2025-10-01T01:34:04Z
github: https://github.com/redbear4013/engaged-app-ccpm/issues/20
depends_on: [15]
parallel: false
conflicts_with: []
---

# Task: Testing & Quality Assurance

## Description

Develop comprehensive test suite covering unit tests, integration tests, E2E tests, and performance benchmarks for the entire scraping pipeline. Ensure >80% code coverage, validate all adapter functionality, test error scenarios, and establish performance baselines. Includes manual QA checklist for production readiness validation.

## Acceptance Criteria

- [ ] Unit tests implemented for all core services
- [ ] Integration tests for all source adapters
- [ ] E2E tests for full scraping workflow
- [ ] Performance benchmarks established
- [ ] Code coverage >80%
- [ ] Manual QA checklist completed
- [ ] All tests passing in CI/CD pipeline
- [ ] Test documentation complete

## Technical Details

### Unit Tests (Jest)

**Test Coverage Areas**:

1. **Tool Selector** (`src/services/scraping/tool-selector.ts`)
   - Escalation logic (Firecrawl → DevTools → Playwright)
   - Coverage threshold triggers (<70% → escalate)
   - SPA marker detection
   - Performance metric tracking

2. **Circuit Breaker** (`src/services/scraping/circuit-breaker.ts`)
   - State transitions (CLOSED → OPEN → HALF_OPEN)
   - Failure counting and threshold triggers
   - Timeout and retry logic
   - Per-source state isolation

3. **Data Pipeline** (`src/services/scraping/pipeline.ts`)
   - Field normalization (dates to UTC, prices to HKD)
   - Event classification rules
   - Deduplication algorithm (3-tier matching)
   - Revision diff generation

4. **Orchestrator** (`src/services/scraping/orchestrator.ts`)
   - Concurrency control (maxConcurrent=3)
   - Source prioritization logic
   - Circuit breaker integration
   - Error aggregation

**Test Structure**:
```typescript
describe('ToolSelector', () => {
  describe('selectAndExtract', () => {
    it('should use Firecrawl first for static content', async () => {
      // Test Firecrawl primary path
    });

    it('should escalate to DevTools when coverage <70%', async () => {
      // Test escalation logic
    });

    it('should escalate to Playwright for SPA markers', async () => {
      // Test SPA detection
    });
  });
});
```

### Integration Tests (Playwright Test)

**Test Coverage Areas**:

1. **Source Adapters** (all 15 sources)
   - Mock HTML responses with realistic content
   - Validate extraction accuracy
   - Test selector resilience to minor HTML changes
   - Verify field coverage calculations

2. **Full Pipeline**
   - Raw extraction → normalization → classification → deduplication → DB upsert
   - Image download and optimization flow
   - Revision tracking and diff generation
   - Alert triggering on anomalies

3. **Alert Manager**
   - Slack webhook integration (with test endpoint)
   - Email alert delivery
   - Alert threshold triggers
   - Alert deduplication

**Test Structure**:
```typescript
describe('BroadwayAdapter Integration', () => {
  it('should extract events from mocked HTML', async () => {
    const html = await fs.readFile('__mocks__/broadway.html', 'utf-8');
    const adapter = new BroadwayAdapter();
    const events = await adapter.scrape(html);

    expect(events).toHaveLength(10);
    expect(events[0]).toMatchObject({
      title: expect.any(String),
      start_date: expect.any(Date),
      venue_name: 'Broadway Macau Theatre',
    });
  });
});
```

### E2E Tests

**Test Scenarios**:

1. **Full Scraping Run**
   - Execute orchestrator with test configuration
   - Validate all sources processed
   - Verify events stored in database
   - Check metrics logged to `scraping_runs`

2. **Error Scenarios**
   - Timeout handling (slow source response)
   - HTTP errors (404, 500, 503)
   - Malformed data (missing required fields)
   - Circuit breaker opening on repeated failures

3. **Tool Fallback Chain**
   - Firecrawl failure → DevTools retry
   - DevTools failure → Playwright retry
   - All tools failed → log error and continue

4. **Circuit Breaker Behavior**
   - Source fails 3 times → circuit opens
   - Circuit stays open for 1 hour
   - Half-open state allows single probe
   - Success → circuit closes

**Test Structure**:
```typescript
describe('Full Scraping Workflow E2E', () => {
  it('should scrape all sources and store to database', async () => {
    const config = loadTestConfig();
    const orchestrator = new Orchestrator(config);

    const results = await orchestrator.run();

    expect(results.totalSources).toBe(15);
    expect(results.successfulSources).toBeGreaterThanOrEqual(13);
    expect(results.totalEventsFound).toBeGreaterThan(0);

    // Verify database writes
    const { data: events } = await supabase.from('events').select('*');
    expect(events.length).toBeGreaterThan(0);
  });
});
```

### Performance Tests

**Benchmarks**:

1. **Extraction Speed**
   - Target: <2s p95 per page
   - Test: Scrape 100 pages across all tools
   - Metric: Time from request to parsed event object

2. **Scraping Run Duration**
   - Target: <15 min p95 for 15 sources
   - Test: Full orchestrator run with concurrency=3
   - Metric: Total execution time

3. **Database Throughput**
   - Target: >100 events/sec bulk insert
   - Test: Insert 1000 events in batches
   - Metric: Total insert time

4. **Image Optimization**
   - Target: <5s per image
   - Test: Download, resize, convert 100 images
   - Metric: Average processing time per image

**Test Structure**:
```typescript
describe('Performance Benchmarks', () => {
  it('should scrape 15 sources in <15 minutes', async () => {
    const start = Date.now();
    await orchestrator.run();
    const duration = Date.now() - start;

    expect(duration).toBeLessThan(15 * 60 * 1000); // 15 min
  });
});
```

### Manual QA Checklist

**Pre-Launch Validation**:
- [ ] Verify all 15 sources extract >80% fields
- [ ] Test manual trigger for each source via dashboard
- [ ] Validate Slack alerts deliver within 1 minute
- [ ] Check email alerts for critical failures
- [ ] Verify circuit breaker opens/closes correctly
- [ ] Test image optimization produces valid WebP
- [ ] Validate deduplication catches obvious duplicates
- [ ] Check event classification accuracy (sample 50 events)
- [ ] Verify revision tracking creates correct diffs
- [ ] Test dashboard loads in <2s with 100+ runs
- [ ] Validate GitHub Actions workflows execute successfully
- [ ] Check secrets properly configured (Supabase, Firecrawl, Slack)

## Dependencies

- [ ] Task 003: Priority 1 Source Adapters (adapters to test)
- [ ] Task 001: Core Infrastructure (orchestrator, tool selector)
- [ ] Task 004: Data Pipeline (normalization, deduplication)
- [ ] Task 006: Monitoring Dashboard (alert manager)

## Effort Estimate

- Size: M
- Hours: 12-16 hours
- Parallel: false (depends on Task 003 completion)

## Definition of Done

- [ ] Unit tests implemented for all core services (>80% coverage)
- [ ] Integration tests for all 15 source adapters
- [ ] E2E tests for full scraping workflow
- [ ] Performance benchmarks meet targets (<2s p95, <15 min run)
- [ ] Manual QA checklist completed with all items passing
- [ ] All tests passing in CI/CD pipeline
- [ ] Test documentation updated
- [ ] Code coverage report generated and reviewed
- [ ] Performance baseline metrics documented
- [ ] Edge case scenarios validated (timeouts, errors, malformed data)
